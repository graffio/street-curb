current_task: "task_1_views"
status: "pending"

# Reference: See docs/architecture/event-sourcing.md for materialized view patterns

tasks:
  - id: "task_1_views"
    description: "Create materialized views for organizations, projects, and users"
    status: "pending"
    phase: "Materialized Views"
    dependencies:
      - "F110:task_1_domain_events"
    estimated_hours: 8
    implementation: |
        - Create Cloud Function trigger listening to completedActions onCreate
        - Implement view handlers in `modules/curb-map/functions/src/views/`:
          * organizationViewHandler.js - update /organizations/{id}
          * projectViewHandler.js - update /organizations/{orgId}/projects/{projId}
          * userViewHandler.js - update /users/{id}
        - Parse Action from completedActions and update appropriate view collection
        - Implement idempotent updates:
          * Track lastProcessedActionId in view documents
          * Skip if action already processed
        - Handle all Action types from F110:
          * OrganizationCreated/Updated/Deleted
          * ProjectCreated/Updated/Deleted
          * UserAdded/Updated/Removed
          * RoleAssigned
        - Write to hierarchical collections for projects
        - Write to flat collections for organizations and users
        - Add basic error handling (log and continue on view update failures)
    validation:
      - "Triggers fire when completedActions are created"
      - "Views update correctly for all Action types"
      - "Idempotent updates prevent duplicate processing"
      - "Hierarchical project collections work"
      - "UI can query views (list orgs, get project, find users)"
    tests:
      - "modules/curb-map/functions/test/organization-view.tap.js"
      - "modules/curb-map/functions/test/project-view.tap.js"
      - "modules/curb-map/functions/test/user-view.tap.js"
      - "modules/curb-map/functions/test/views-integration.firebase.js"
    notes: |
      This creates the minimum views needed for F113's React UI.

      SCOPE:
      - completedActions onCreate triggers
      - Basic view updates for all Action types
      - Idempotent processing
      - Hierarchical and flat collections
      - Error handling

      OUT OF SCOPE (defer to backlog):
      - Complex aggregations
      - View optimization
      - Advanced querying
      - Performance tuning

      Views are eventually consistent - there may be a delay between
      action completion and view updates. This is acceptable for MVP.

      F111 (offline infrastructure) deferred until mobile apps are built.

completed: []

notes: |
    This specification implements materialized views for CurbMap.

    SCOPE:
    - completedActions onCreate triggers
    - Organization, project, and user view handlers
    - Idempotent view updates
    - Basic querying support

    DEPENDS ON:
    - F110: Domain model (Action types that generate events)
    - F108: Event sourcing (completedActions collection)

    ENABLES:
    - F113: React/Redux UI (needs views to display/query data)

    DEFERRED:
    - F111: Offline infrastructure (until mobile apps are built)

    Total: 8 hours

    Task ID format: task_{phase}_{sequence}_{description}
    Status values: pending, in_progress, completed, blocked, cancelled
    Dependencies: List of task IDs that must be completed first
    Validation: Specific criteria that must be met for task completion
