references:
  - name: "event-sourcing"
    path: ../../docs/architecture/event-sourcing.md
  - name: "multi-tenant"
    path: ../docs/architecture/multi-tenant.md
  - name: "authentication"
    path: ../docs/architecture/authentication.md

current_task: "task_2_1_action_request_utilities"
status: "pending"

# Reference: See ../../docs/architecture/event-sourcing.md for detailed patterns, helper signatures, and decision log

tasks:
  - id: "task_1_1_create_tagged_types_and_helpers"
    description: "Create ActionRequest and Action tagged types with Firestore integration helpers"
    status: "completed"
    phase: "Foundation"
    dependencies: [ ]
    estimated_hours: 5
    implementation: |
        - Create ActionRequest and Action (DomainEvent) in modules/curb-map/type-definitions/
      - Add toFirestore/fromFirestore functions while leaving raw Date values on the tagged types
      - Mark timestamp-bearing fields via `Type.timestampFields` so facades can handle conversion per runtime
      - Add comprehensive error handling and validation
      - Follow existing patterns from audit-record.js and operation-details.js
    validation:
      - "Tagged types validate ActionRequest structure correctly"
      - "toFirestore/fromFirestore functions handle Date/ServerTimestamp conversion"
      - "Date conversion functions work correctly in client context"
      - "Error handling covers edge cases"
      - "Types integrate with existing Firestore patterns"
    tests:
      - "modules/curb-map/test/action-request-types.tap.js"
      - "modules/curb-map/test/firestore-helpers.tap.js"

  - id: "task_1_2_setup_integration_testing"
    description: "Set up Firebase emulator integration testing infrastructure"
    status: "completed"
    phase: "Foundation"
    dependencies:
      - "task_1_1_create_tagged_types_and_helpers"
    estimated_hours: 4
    implementation: |
      - Create test utilities following firebase-integration-tests-strategy.md
      - Set up namespaced testing with DISABLE_TRIGGERS support
      - Create seed/cleanup utilities for test isolation
      - Add emulator configuration and CI/CD integration
      - Create actual test files to validate the integration testing setup works
    validation:
      - "Test isolation works with namespaced data"
      - "Trigger guards prevent unwanted side effects during seeding"
      - "Cleanup removes only test data"
      - "Integration testing examples from firebase-integration-tests-strategy.md work"
    tests:
      - "modules/curb-map/test/firestore-admin.firebase.js"

  - id: "task_1_3_create_functions_workspace"
    description: "Create dedicated Firebase functions workspace following firebase-functions-deploy.md"
    status: "completed"
    phase: "Foundation"
    dependencies:
      - "task_1_1_create_tagged_types_and_helpers"
    estimated_hours: 3
    implementation: |
      - Create modules/curb-map-functions workspace with package.json
      - Add Firebase dependencies (firebase-functions, firebase-admin)
      - Add internal package dependencies via workspace aliases
      - Set up esbuild bundling configuration
      - Update firebase.json to point to the functions workspace
      - Add build and deploy scripts following firebase-functions-deploy.md patterns
    validation:
      - "Functions workspace builds successfully"
      - "Firebase CLI can deploy from the workspace"
      - "Internal packages are available during build"
      - "CI/CD workflow can build and deploy functions"
    tests:
      - "modules/curb-map-functions/test/build.tap.js"
      - "modules/curb-map-functions/test/deploy.tap.js"

  - id: "task_1_4_create_minimal_giant_function"
    description: "Create minimal queue processing function for integration testing"
    status: "completed"
    phase: "Foundation"
    dependencies:
      - "task_1_2_setup_integration_testing"
      - "task_1_3_create_functions_workspace"
    estimated_hours: 4
    implementation: |
      - Create minimal queue processing function in modules/curb-map-functions/src/
      - Implement trigger guard (DISABLE_TRIGGERS) for test seeding
      - Add structured logging and error handling
      - Focus on enabling integration tests, not full production features
        - Use ActionRequest and Action types from curb-map workspace
    validation:
      - "Function processes queue items and creates events"
      - "Trigger guard works correctly during test seeding"
      - "Error handling and logging function properly"
      - "Function integrates with tagged types correctly"
    tests:
      - "modules/curb-map-functions/test/minimal-giant-function.tap.js"
      - "modules/curb-map-functions/test/minimal-giant-function.firebase.js"

  - id: "task_1_5_create_queue_collection"
    description: "Create Firestore actionRequests and completedActions collections with security rules and indexes"
    status: "completed"
    phase: "Foundation"
    dependencies:
      - "task_1_4_create_minimal_giant_function"
    estimated_hours: 6
    implementation: |
      ‚úÖ Created ActionRequest type (renamed from QueueItem) in modules/curb-map/type-definitions/
      ‚úÖ Added new SOC2 fields to ActionRequest: subject, organizationId, projectId, correlationId, schemaVersion
      ‚úÖ Removed eventId field (simplified to use id for both collections)
      ‚úÖ Updated collection name from 'queueItems' to 'actionRequests' in firestore-facade-shared.js
      ‚úÖ Added 'completedActions' collection registration (write-once, immutable audit trail)
      ‚úÖ Removed incorrect 'actions' collection registration
      ‚úÖ Created firestore.indexes.json with composite indexes:
        * actionRequests: organizationId + status + createdAt
        * actionRequests: actorId + status + createdAt
        * actionRequests: organizationId + projectId + status + createdAt
        * completedActions: organizationId + createdAt
        * completedActions: organizationId + projectId + createdAt
        * completedActions: organizationId + actorId + createdAt
        * completedActions: idempotencyKey
      ‚úÖ Updated firestore.rules for actionRequests collection with comprehensive field validation:
        * Validate all ID field formats (acr_, usr_, org_, prj_, idm_, cor_)
        * Validate subjectType enum (user, organization, project)
        * Validate status enum (pending, completed, failed)
        * Validate schemaVersion (must be 1)
        * Ensure pending requests have no resultData/error/processedAt
        * Allow authenticated users to create if actorId matches auth.uid
        * Allow users to read their own requests and organization members to read org requests
        * Prevent all client updates (only Cloud Functions can update)
      ‚úÖ Added firestore.rules for completedActions collection:
        * Read-only for authorized users within organization
        * Write-only for Firebase Functions (no client writes)
      ‚úÖ Updated documentation to remove eventId references
      ‚úÖ Created integration test: modules/curb-map/test/action-request-collection.firebase.js
      üìù Next: Update handle-action-request-added.js to copy completed ActionRequest to completedActions
      üìù Next: Validate behaviour locally with Firebase emulator
    validation:
      ‚úÖ "ActionRequest type exists with all SOC2 fields (subject, organizationId, correlationId, schemaVersion)"
      ‚úÖ "eventId field removed (simplified architecture using id for both collections)"
      ‚úÖ "actionRequests collection registered and accepts creates from authenticated users"
      ‚úÖ "completedActions collection registered as write-once, immutable"
      ‚úÖ "Comprehensive field-level validation in security rules"
      ‚úÖ "Client cannot update any fields in actionRequests (only Cloud Functions)"
      ‚úÖ "Composite indexes created for efficient queries"
      üìù "Unauthorized writes/reads are rejected by emulator security tests"
      üìù "Rule + index deployments logged in infrastructure runbook"
    tests:
      - "modules/curb-map/test/firestore-admin.firebase.js"

  - id: "task_2_2_giant_function"
    description: "Create main action request processing orchestrator (infrastructure only)"
    status: "pending"
    phase: "Function Implementation"
    dependencies:
      - "task_2_3_idempotency"
      - "task_3_1_event_types"
      - "F109:task_4_2_authz_middleware"
    estimated_hours: 4
    implementation: |
      - Implement `modules/curb-map/functions/src/events/process-action-requests.js` as orchestration layer only.
      - Process flow: validate structure (task_3_1) ‚Üí check idempotency (task_2_3) ‚Üí authorize (F109 task_4_2) ‚Üí dispatch to domain handlers (F110) ‚Üí copy to completedActions ‚Üí mark completed/failed.
      - DO NOT implement domain logic here (no UserAdded/OrganizationAdded handling) - domain handlers belong in F110.
      - Persist status transitions (`pending ‚Üí processing ‚Üí completed/failed`) exactly as documented under "Action Request Lifecycle".
      - Emit structured logs (`actionRequestId`, `actionType`, `attempt`, `durationMs`).
      - Copy completed ActionRequest to completedActions collection for immutable audit trail.
    validation:
      - "On-create trigger processes new action requests through orchestration flow"
      - "Failures mark action request docs with status=failed and retain error context"
      - "Completed action requests are copied to completedActions collection"
      - "Idempotent replays leave action request unchanged"
    tests:
      - "modules/curb-map-functions/test/process-action-requests.tap.js"
      - "modules/curb-map-functions/test/process-action-requests.firebase.js"
    notes: |
      This is the orchestration layer only. Domain-specific event handlers (UserAdded, OrganizationAdded, etc.)
      are implemented in F110 (Multi-Tenant Data Model). This function dispatches to those handlers.

  - id: "task_2_3_idempotency"
    description: "Implement idempotency checks to prevent duplicate processing"
    status: "pending"
    phase: "Function Implementation"
    dependencies:
      - "task_1_5_create_queue_collection"
    estimated_hours: 4
    implementation: |
      - Persist processed operations in the `processed_operations` store described in "Idempotency Pattern".
      - Reuse helper signatures (`checkIdempotencyKey`, `storeIdempotencyResult`) from the architecture doc; keep them side-effect free for unit tests.
      - Enforce uniqueness using Firestore doc IDs or unique indexes per idempotency key.
      - Document retry escalation rules in the runbook.
    validation:
      - "Duplicate idempotency keys short-circuit without recreating events"
      - "Processed operations contain actor, timestamp, result snapshot"
      - "Manual replay procedures documented for operations team"
    tests:
      - "modules/curb-map-functions/test/idempotency.tap.js"

  - id: "task_3_1_event_types"
    description: "Define event types and validation schemas"
    status: "pending"
    phase: "Event Types and Validation"
    dependencies:
      - "task_1_5_create_queue_collection"
    estimated_hours: 3
    implementation: |
      - Establish the event registry API outlined under "Event Validation" (define schema, validator, sanitizer per event type).
      - Store specifications in `modules/curb-map/functions/src/events/event-types.js` with pure data + helpers.
      - Define Action type schemas (structure validation only, not domain logic).
      - Reference organization/project scoping rules from ../../docs/architecture/multi-tenant.md.
    validation:
      - "Registry rejects malformed action payloads with actionable messages"
      - "Schema versions tracked for future migrations"
      - "Unit tests cover Action structure validation happy + sad paths"
    tests:
      - "modules/curb-map-functions/test/event-types.tap.js"
    notes: |
      This task defines Action TYPE schemas only (structure validation).
      Authorization logic is in F109 task_4_2.
      Domain event handlers are in F110 task_1_1, task_2_1.

  - id: "task_5_1_integration_testing"
    description: "Validate end-to-end event sourcing infrastructure workflow"
    status: "pending"
    phase: "Testing and Validation"
    dependencies:
      - "task_2_2_giant_function"
    estimated_hours: 4
    implementation: |
      - Build TAP harness testing core infrastructure flow: enqueue ‚Üí validate ‚Üí check idempotency ‚Üí authorize ‚Üí copy to completedActions.
      - Test orchestration layer only - use mock domain handlers (do not test actual domain logic here).
      - Add load test script following "Performance Testing" guidance to simulate burst workloads.
      - Document manual validation steps in `docs/runbooks/event-sourcing.md`.
    validation:
      - "End-to-end TAP suite passes (enqueue ‚Üí validate ‚Üí authorize ‚Üí audit)"
      - "Idempotency prevents duplicate processing"
      - "Authorization integration works with F109 middleware"
      - "CompletedActions audit trail is created correctly"
      - "Performance target met for 95th percentile processing time"
    tests:
      - "modules/curb-map-functions/test/event-sourcing.firebase.js"
      - "modules/curb-map-functions/test/event-sourcing.load.sh"
    notes: |
      This tests the event sourcing INFRASTRUCTURE only.
      Domain-specific integration tests (organizations, projects, users) are in F110 task_6_1.

completed: [ "task_1_1_create_tagged_types_and_helpers", "task_1_2_setup_integration_testing", "task_1_3_create_functions_workspace", "task_1_4_create_minimal_giant_function", "task_1_5_create_queue_collection" ]

notes: |
  This specification implements the core event sourcing INFRASTRUCTURE for CurbMap.

  SCOPE: This spec covers infrastructure only:
  - Action request queue processing (actionRequests ‚Üí completedActions)
  - Validation (structure checking)
  - Idempotency (duplicate prevention)
  - Orchestration (dispatch to domain handlers)
  - Audit trail (completedActions collection)

  OUT OF SCOPE (belongs in other specs):
  - Authorization: F109 task_4_2 (authorization middleware)
  - Domain logic: F110 (organization/project/user event handlers)
  - Materialized views: F110 task_3_1, task_3_2, task_3_3
  - Client-side queue: F111 (offline queue architecture)
  - Action request helpers: F111 task_1_1 (client-side, deferred until Actions defined)

  Task ID format: task_{phase}_{sequence}_{description}
  Status values: pending, in_progress, completed, blocked, cancelled
  Dependencies: List of task IDs that must be completed first
  Validation: Specific criteria that must be met for task completion
