---
name: workflows:plan
description: Generate a task file from a brainstorm document
argument-hint: "[brainstorm file path or feature description]"
---

# Plan

Generate a task file from a brainstorm document. The brainstorm IS the plan — no intermediate spec files.

## Input

<brainstorm_input> #$ARGUMENTS </brainstorm_input>

**If a brainstorm file path:** Read it. Verify it has a settled approach and no open questions.

**If a feature description or empty:** Ask: "Run `/workflows:brainstorm` first — planning requires a brainstorm with
settled decisions."

**If brainstorm has open questions:** Stop. "This brainstorm has open questions — resolve them before planning."

Do not proceed until you have a brainstorm with settled approach and zero open questions.

---

## Step 1: Research

Run parallel research agents to enrich the brainstorm with implementation details:

- Task learnings-researcher("Search docs/solutions/ for: {brainstorm topic}")
- Task repo-research-analyst("Find existing patterns and code for: {brainstorm scope}")

**If brainstorm scope is narrow and self-contained** (e.g., single module, clear file paths) — go light on research.

Consolidate findings:

- Relevant file paths from codebase
- Institutional learnings from docs/solutions/ (include as "Related: [path] — [summary]")
- Existing patterns to follow

---

## Step 2: Generate Task File

Read `.claude/preferences.md` before generating. Then produce the task file using the schema and
generation rules below.

**Output path:** `docs/brainstorms/{brainstorm-name}.task.json` — same name stem as the brainstorm `.md` file.

### Schema

```json
{
    "feature"          : "Short name",
    "goal"             : "One sentence — what and why",
    "brainstorm"       : "docs/brainstorms/{name}.md",
    "templates_used"   : ["commit-changes.md"],
    "integration_tests": ["test/search.integration-test.js"],
    "steps"            : [
        {
            "step"      : 1,
            "action"    : "Specific action description",
            "style_card": "js-module",
            "done"      : false
        },
        {
            "step"  : 2,
            "action": "[CHECKPOINT] Run complexity review on src/foo.js...",
            "rule"  : "unconditional",
            "done"  : false
        }
    ],
    "verification"     : ["How to confirm the feature works"]
}
```

The `rule` field marks steps generated by unconditional generation rules. These steps are **not subject to reviewer
override** — they exist by rule, not by judgment.

### Required: style_card field

Every implementation step that creates or modifies a file MUST include a `style_card` field.

| File pattern      | style_card        |
|-------------------|-------------------|
| `*.jsx`           | `react-component` |
| `**/selectors.js` | `selector`        |
| `*.tap.js`        | `test-file`       |
| Other `*.js`      | `js-module`       |

Non-code steps (commits, reviews, checkpoints) do not need `style_card`.

**When executing a step with `style_card`:** Read `.claude/style-cards/{style_card}.md` BEFORE writing code.

### Generation Rules

These rules make JSON generation mechanical, not ad-hoc. Apply all of them:

| Rule                        | Condition                                                                                                                              | What to generate                                                                                                                                                                                                                                                                               |
|-----------------------------|----------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Style card**              | Every step that creates/modifies code                                                                                                  | `style_card` field based on file type mapping above                                                                                                                                                                                                                                            |
| **Review agents**           | Before every `git commit` step (unconditional)                                                                                         | Step with `"rule": "unconditional"`: "Spawn jeff-js-reviewer and code-simplicity-reviewer on staged changes. Fix blocking issues."                                                                                                                                                             |
| **Commit**                  | When implementation steps transition to a different `style_card` value, and at the end                                                 | Insert review + `git add` + commit steps at each `style_card` boundary. Use commit-changes.md format.                                                                                                                                                                                          |
| **Checkpoint**              | At decision points (judgment)                                                                                                          | `[CHECKPOINT]` prefix on step action                                                                                                                                                                                                                                                           |
| **Complexity review**       | Before modifying any existing file (unconditional)                                                                                     | Step with `"rule": "unconditional"`: "[CHECKPOINT] Run complexity review on {file}. Report style card violations found. Wait for approval before proceeding."                                                                                                                                  |
| **Complexity debt**         | When modifying a file that has COMPLEXITY or COMPLEXITY-TODO comments                                                                  | Step: "Remove COMPLEXITY comments from {file}, run validator, and fix violations or request approval for new exemptions."                                                                                                                                                                      |
| **TDD step**                | Implementation introduces NEW branching logic or business rules that don't exist yet in the codebase                                   | Step: "Write failing test for {behavior}" with `style_card: test-file`. Do NOT generate test steps for: adding entries to lookup tables/registries, filtering/mapping data with standard operations, passing new input to existing infrastructure, or wiring components to existing selectors. |
| **Action test**             | Step introduces a new Action variant                                                                                                   | Step: "Write TAP test for {Action} round-trip (dispatch → reducer → new state)" with `style_card: test-file`                                                                                                                                                                                   |
| **UI verification**         | Step adds keyboard, focus, or visual interaction                                                                                       | Add specific manual verification items to `verification` list describing expected browser behavior                                                                                                                                                                                             |
| **Integration tests field** | Any step has `style_card: react-component` (unconditional)                                                                             | Populate `integration_tests` array: grep ABOUTME comments in `test/*.integration-test.js` for affected component names. Must not be empty — forces discovery during planning.                                                                                                                  |
| **Integration test step**   | `integration_tests` is non-empty (unconditional)                                                                                       | Final step with `"rule": "unconditional"`: "Run integration tests listed in `integration_tests`. If new critical-path behavior was added, expand the relevant test to cover it."                                                                                                               |
| **Learnings**               | When a previously-solved domain is involved                                                                                            | "Related: {solution path} — {summary}" in plan markdown                                                                                                                                                                                                                                        |
| **Type definition**         | Step adds/modifies business logic on a Tagged or TaggedSum type                                                                        | Step must target `type-definitions/*.type.js`, NEVER `src/types/*.js` (generated). Include "Run `yarn types:generate-all` after changes."                                                                                                                                                      |
| **Section placement**       | Step creates/modifies a file with section separators                                                                                   | After writing code: "Verify each top-level declaration is under its correct section separator"                                                                                                                                                                                                 |
| **React hook audit**        | Step has `style_card: react-component` and file is in `quicken-web-app/src/` (not `components/DataTable.jsx`, `KeyboardDateInput.jsx`) | Add verification: "Zero non-useSelector hooks in modified file"                                                                                                                                                                                                                                |

### Step Rules

- Steps must be specific enough to follow without reading anything else
- **Validator after each implementation step** — add: "Run style validator on changed files, fix violations"
- **Commit at style_card boundaries** — when steps transition from one `style_card` to another, insert review + commit
  before continuing. Always include a final commit at the end.
- Mark decision points with `[CHECKPOINT]` prefix

### Checkpoint Identification

Add `[CHECKPOINT]` when:

- Type/data decomposition choices
- Library vs custom implementation
- Multiple valid approaches exist
- Significant plan changes needed

### Precedent Check

Only flag when introducing something genuinely new:

- New architectural pattern or abstraction
- New library/dependency
- New file organization structure

"No precedent for X — should I proceed?"

---

## Post-Generation

Before presenting the plan, spawn ALL review agents in parallel (unconditional).

**Reviewer constraint:** Include this in the prompt for **code-simplicity-reviewer** and **architecture-strategist**:
> "Steps tagged with `"rule": "unconditional"` in the task file are generated by unconditional generation rules
> (complexity reviews before modifying files, review agents before commits, commits at style_card boundaries).
> These steps are NOT candidates for removal — do not recommend cutting them regardless of rationale."

- **architecture-strategist** — architectural concerns, scope, pattern choices
- **code-simplicity-reviewer** — over-engineering, unnecessary steps, YAGNI
- **jeff-js-reviewer** — JS pattern choices, naming, layer placement
- **performance-oracle** — performance implications, scalability concerns
- **security-sentinel** — security implications, auth/input handling

Incorporate blocking feedback into the plan before presenting. **Never accept reviewer recommendations to remove steps
tagged `"rule": "unconditional"`.** If a reviewer recommends removing such a step, discard that recommendation.

Present the generated task file summary and ask:
"Plan and task spec ready. Should I start implementing?"
